<!DOCTYPE html>
<html>
<head>
  <title>GA4 ë°ì´í„° ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸</title>
  <meta charset="utf-8">
  <style>
    /* ê¸°ë³¸ í°íŠ¸ ë° ë ˆì´ì•„ì›ƒ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.4; color: #333; margin: 0; padding: 0; background-color: #f9f9f9; }
    .container { max-width: 1000px; margin: 20px auto; padding: 25px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    /* íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
    h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-top: 0; font-size: 1.6em; }
    h3 { color: #34495e; margin-top: 40px; margin-bottom: 15px; font-size: 1.3em; border-left: 5px solid #3498db; padding-left: 12px; }
    
    /* ìƒë‹¨ ìš”ì•½ ë°•ìŠ¤ */
    .summary-box { background-color: #f1f8ff; padding: 20px; border-radius: 8px; border: 1px solid #d1e3f6; margin-bottom: 30px; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.9em; font-weight: bold; color: white; margin-right: 5px; }
    .bg-critical { background-color: #e53935; } 
    .bg-warning { background-color: #fb8c00; } 
    .bg-notice { background-color: #1e88e5; } 

    /* í…Œì´ë¸” ê³µí†µ ìŠ¤íƒ€ì¼ */
    table { border-collapse: separate; border-spacing: 0; width: 100%; margin-bottom: 20px; font-size: 0.9em; table-layout: fixed; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
    
    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    thead th { background-color: #f1f5f9; color: #555; font-weight: 700; letter-spacing: -0.5px; height: 45px; padding: 5px; border-bottom: 1px solid #ddd; border-right: 1px solid #eee; }
    thead th.current-col { width: 14%; background-color: #fff3e0; border-left: 2px solid #ffb74d; border-right: 2px solid #ffb74d; color: #e65100; }
    
    /* [ìˆ˜ì •] ì²« ë²ˆì§¸ ì»¬ëŸ¼(ì¸¡ì •ê¸°ì¤€/í•­ëª©) ìŠ¤íƒ€ì¼ - ë„ˆë¹„ ì•½ê°„ í™•ëŒ€ */
    tbody th.metric-col { width: 18%; text-align: left; padding: 10px 15px; background-color: #ffffff; color: #333; border-bottom: 1px solid #eee; border-right: 1px solid #eee; word-break: break-all; }
    
    /* ë°ì´í„° ì…€ ìŠ¤íƒ€ì¼ */
    tbody td { padding: 12px 5px; text-align: center; vertical-align: middle; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
    tbody td.current-data-cell { background-color: #fffbf2; border-left: 2px solid #ffb74d; border-right: 2px solid #ffb74d; }
    
    .current-val { font-size: 1.4em; font-weight: 800; color: #222; display: block; }
    .old-val { display: block; font-weight: 500; color: #666; margin-bottom: 4px; font-size: 0.95em; }
    .pct { display: block; font-size: 0.9em; font-weight: 800; }
    
    .pct.plus { color: #d32f2f; }
    .pct.minus { color: #1976d2; }
    .pct.zero { color: #9e9e9e; }
    .pct.new { color: #e65100; font-weight: 900; }
    
    td.critical { background-color: #ffcdd2 !important; }
    td.warning { background-color: #ffe0b2 !important; }
    td.notice { background-color: #e3f2fd !important; }
    td.normal { background-color: #ffffff; color: #ccc; }

    .footer { font-size: 0.8em; color: #999; text-align: center; margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; }
  </style>
</head>
<body>
  <div class="container" id="report-container">
    <p style="text-align:center; padding:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
  </div>

  <script>
    // 2. n8n ë¡œì§ì„ ë¸Œë¼ìš°ì €ìš© ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë³€í™˜
    async function renderReport() {
      try {
        // sample.json íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const response = await fetch('./sample.json'); 
        const data = await response.json();
        
        // n8n ë³€ìˆ˜ëª…($json)ì„ í‰ë‚´ë‚´ì–´ ì½”ë“œ ìˆ˜ì •ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.
        // ë§Œì•½ sample.jsonì´ ë°°ì—´([...]) í˜•íƒœë¼ë©´ data[0]ì„ ì‚¬ìš©, ê°ì²´ë¼ë©´ data ì‚¬ìš©
        const $json = Array.isArray(data) ? data[0] : data; 

        // ---------------------------------------------------------
        // ì—¬ê¸°ì„œë¶€í„°ëŠ” n8n ë¡œì§ì„ JS Template Literalë¡œ ë³€í™˜í•œ ê²ƒì…ë‹ˆë‹¤.
        // ---------------------------------------------------------
        
        // ìš”ì•½ ë°°ì§€ HTML ìƒì„±
        const summaryHtml = `
          <div class="summary-box">
            <div style="margin-bottom:8px; font-size:1.1em;"><strong>ğŸ“… ì¡°íšŒ ë‚ ì§œ:</strong> ${$json.latestDate}</div>
            <div style="margin-bottom:12px;"><strong>ğŸ¢ ê³„ì •/ì†ì„±:</strong> ${$json.gaName.account_name} / ${$json.gaName.property_name}</div>
            <div>
              <span class="badge bg-critical">Critical: ${$json.summary.critical}</span>
              <span class="badge bg-warning">Warning: ${$json.summary.warning}</span>
              <span class="badge bg-notice">Notice: ${$json.summary.notice}</span>
            </div>
          </div>
        `;

        // ì¹´í…Œê³ ë¦¬ë³„ í…Œì´ë¸” HTML ìƒì„±
        const tablesHtml = Object.keys($json.alertsByCategory).map(category => {
          const categoryConfig = {
            visitorMetrics: { title: 'ğŸ‘¥ ë°©ë¬¸ì ì§€í‘œ (Visitor)', header: 'ì¸¡ì • í•­ëª©' },
            user_acquisition: { title: 'ğŸš¦ ìœ ì… ì±„ë„ (Acquisition)', header: 'ì†ŒìŠ¤ / ë§¤ì²´' },
            events: { title: 'ğŸ–±ï¸ ì£¼ìš” ì´ë²¤íŠ¸ (Events)', header: 'ì´ë²¤íŠ¸ëª…' }
          };
          
          const config = categoryConfig[category] || { title: category, header: 'êµ¬ë¶„' };
          const alerts = $json.alertsByCategory[category];
          
          if (!alerts || alerts.length === 0) return '';

          const rows = {};
          alerts.forEach(a => {
              const key = a.dimension !== 'total' ? a.dimension : a.metric;
              if (!rows[key]) {
                  rows[key] = { currentValue: a.newValue, cells: {} };
              }
              rows[key].cells[a.changeType] = a; 
          });

          const cols = [
              { key: 'yesterday', label: 'ì „ì¼ ëŒ€ë¹„' },
              { key: 'sameDayLastWeek', label: 'ì§€ë‚œì£¼ ë™ìš”ì¼' },
              { key: 'avg7', label: '7ì¼ í‰ê· ' },
              { key: 'avg14', label: '14ì¼ í‰ê· ' },
              { key: 'avg30', label: '30ì¼ í‰ê· ' }
          ];

          const tableBody = Object.keys(rows).map(metricName => {
              const rowData = rows[metricName];
              const currentValFormatted = rowData.currentValue.toLocaleString();

              const cells = cols.map(col => {
                  const item = rowData.cells[col.key];
                  
                  if (!item) {
                      return `<td class="normal">-</td>`; 
                  }

                  let oldValText = item.oldValue.toLocaleString();
                  let pctHtml = '';
                  
                  if (item.changePct >= 99999) {
                      oldValText = '0';
                      pctHtml = `<span class="pct new">NEW (+âˆ)</span>`;
                  } else if (item.changePct === -100 && item.newValue === 0) {
                      oldValText = item.oldValue.toLocaleString();
                      pctHtml = `<span class="pct minus">ì†Œì‹¤ (-100%)</span>`;
                  } else {
                      const sign = item.changePct > 0 ? '+' : '';
                      const colorClass = item.changePct > 0 ? 'plus' : (item.changePct < 0 ? 'minus' : 'zero');
                      pctHtml = `<span class="pct ${colorClass}">${sign}${item.changePct}%</span>`;
                  }

                  return `
                      <td class="${item.level || ''}">
                          <span class="old-val">${oldValText}</span>
                          ${pctHtml}
                      </td>
                  `;
              }).join('');

              return `
                  <tr>
                      <th class="metric-col">${metricName}</th>
                      <td class="current-data-cell">
                          <span class="current-val">${currentValFormatted}</span>
                      </td>
                      ${cells}
                  </tr>
              `;
          }).join('');

          return `
            <h3>${config.title}</h3>
            <table>
              <thead>
                <tr>
                  <th style="width:18%; text-align:left; padding-left:15px;">${config.header}</th>
                  <th class="current-col">ê¸°ì¤€ì¼ ë°ì´í„°<br><span style="font-size:0.8em; font-weight:normal">(${ $json.latestDate })</span></th>
                  ${cols.map(c => `<th>${c.label}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${tableBody}
              </tbody>
            </table>
          `;
        }).join('');

        // ìµœì¢… HTML ì¡°ë¦½ ë° ì£¼ì…
        const finalHtml = `
          <h2>ğŸ“Š GA4 ë°ì¼ë¦¬ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸</h2>
          ${summaryHtml}
          ${tablesHtml}
          <p class="footer">
            * ë³¸ ë¦¬í¬íŠ¸ëŠ” sample.json ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë Œë”ë§ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            Test View Mode
          </p>
        `;

        document.getElementById('report-container').innerHTML = finalHtml;

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('report-container').innerHTML = `
          <p style="color:red; text-align:center;">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
            1. sample.json íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
            2. ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì‹œ ë¸Œë¼ìš°ì € ë³´ì•ˆ(CORS) ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Live Server ë“±ì„ ì´ìš©í•˜ì„¸ìš”)<br>
            ì—ëŸ¬ ë‚´ìš©: ${error.message}
          </p>`;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    renderReport();
  </script>
</body>
</html>
