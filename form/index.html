<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM ë§í¬ ìƒì„±</title>
    <style>
        .required {
            color: red;
            font-weight: bold;
        }
        #responseContainer {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="dv1">
        <div class="dv2">
            <h1>UTM ë§í¬ ìƒì„±</h1>
            <form id="utmForm">
                <!-- ê¸°ë³¸ í•„ìˆ˜ í•­ëª© -->
                <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span>:</label>
                <input type="text" id="page_url" name="page_url" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

                <label for="utm_source">UTM Source <span class="required">(í•„ìˆ˜)</span>:</label>
                <input type="text" id="utm_source" name="utm_source" required placeholder="google" oninput="updateFinalURL()"><br><br>

                <label for="utm_medium">UTM Medium <span class="required">(í•„ìˆ˜)</span>:</label>
                <input type="text" id="utm_medium" name="utm_medium" required placeholder="cpc" oninput="updateFinalURL()"><br><br>

                <!-- UTM Campaign êµ¬ì„± -->
                <fieldset style="border:1px solid #ccc; padding:10px;">
                    <legend>UTM Campaign êµ¬ì„±</legend>

                    <label>ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span>:</label>
                    <input type="text" id="campaign_date" placeholder="20250424" oninput="updateFinalURL()" required><br><br>

                    <label>ê´‘ê³ íƒ€ì… <span class="required">(í•„ìˆ˜)</span>:</label>
                    <input type="text" id="ad_type" placeholder="display" oninput="updateFinalURL()" required><br><br>

                    <label>ìº í˜ì¸ëª©í‘œ:</label>
                    <input type="text" id="campaign_goal" placeholder="awareness" oninput="updateFinalURL()"><br><br>

                    <label>ê¸°íšì „ì¢…ë¥˜:</label>
                    <input type="text" id="event_type" placeholder="spring_sale" oninput="updateFinalURL()"><br><br>

                    <label>ìƒí’ˆì¹´í…Œê³ ë¦¬:</label>
                    <input type="text" id="product_category" placeholder="shoes" oninput="updateFinalURL()"><br><br>

                    <label>ê´‘ê³ íƒ€ê²Ÿ:</label>
                    <input type="text" id="ad_target" placeholder="women" oninput="updateFinalURL()"><br><br>

                    <label>ì†Œì¬íƒ€ì…:</label>
                    <input type="text" id="creative_type" placeholder="banner" oninput="updateFinalURL()"><br><br>

                    <label>ê¸°ê¸°ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span>:</label>
                    <input type="text" id="device_type" placeholder="mobile" oninput="updateFinalURL()" required><br><br>
                </fieldset>

                <!-- UTM Content êµ¬ì„± -->
                <fieldset style="border:1px solid #ccc; padding:10px;">
                    <legend>UTM Content êµ¬ì„±</legend>

                    <label>ëª©í‘œí–‰ë™:</label>
                    <input type="text" id="content_action" placeholder="click" oninput="updateFinalURL()"><br><br>

                    <label>ì¶”ê°€ê¸°ì…ì‚¬í•­:</label>
                    <input type="text" id="content_detail" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br>

                    <label>ë²„ì „:</label>
                    <input type="text" id="content_version" placeholder="v1" oninput="updateFinalURL()"><br><br>
                </fieldset>

                <!-- UTM Term ì…ë ¥ -->
                <label for="utm_term">UTM Term (ì„ íƒ):</label>
                <input type="text" id="utm_term" name="utm_term" placeholder="shoes" oninput="updateFinalURL()"><br><br>

                <!-- ìˆ¨ê²¨ì§„ í•„ë“œ (ì„œë²„ ì œì¶œìš©) -->
                <input type="hidden" id="utm_campaign" name="utm_campaign" required>
                <input type="hidden" id="utm_content" name="utm_content">

                <!-- ìµœì¢… URL ì¶œë ¥ -->
                <label for="final_url">ìµœì¢… URL:</label>
                <input type="text" id="final_url" disabled style="width:100%; font-family:monospace;">

                <button type="submit">ì œì¶œ</button>
            </form>

            <!-- ë‹¨ì¶• URL ì‘ë‹µ í‘œì‹œ ì˜ì—­ -->
            <div id="responseContainer">
                <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
                <input id="shortUrlInput" readonly style="width:100%; font-family:monospace;">
                <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
            </div>
        </div>
    </div>

    <script>
        function getValueOrN(id) {
            const value = document.getElementById(id).value.trim();
            return value === "" ? "N" : value;
        }

        function combineUTMValues() {
            // í•„ìˆ˜ í•­ëª© ì²´í¬
            const requiredIds = ["campaign_date", "ad_type", "device_type"];
            for (let id of requiredIds) {
                if (document.getElementById(id).value.trim() === "") {
                    alert("utm_campaign í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return false;
                }
            }

            // utm_campaign ì¡°í•©
            const campaignParts = [
                getValueOrN("campaign_date"),
                getValueOrN("ad_type"),
                getValueOrN("campaign_goal"),
                getValueOrN("event_type"),
                getValueOrN("product_category"),
                getValueOrN("ad_target"),
                getValueOrN("creative_type"),
                getValueOrN("device_type")
            ];
            document.getElementById("utm_campaign").value = campaignParts.join("_");

            // utm_content ì¡°í•©
            const contentParts = [
                getValueOrN("content_action"),
                getValueOrN("content_detail"),
                getValueOrN("content_version")
            ];
            document.getElementById("utm_content").value = contentParts.join("_");

            return true;
        }

        function updateFinalURL() {
            const pageUrl = document.getElementById("page_url").value.trim();
            const utmSource = document.getElementById("utm_source").value.trim();
            const utmMedium = document.getElementById("utm_medium").value.trim();
            
            // ì‹¤ì‹œê°„ utm_campaign ì¡°í•©
            const utmCampaign = [
                getValueOrN("campaign_date"),
                getValueOrN("ad_type"),
                getValueOrN("campaign_goal"),
                getValueOrN("event_type"),
                getValueOrN("product_category"),
                getValueOrN("ad_target"),
                getValueOrN("creative_type"),
                getValueOrN("device_type")
            ].join("_");
            document.getElementById("utm_campaign").value = utmCampaign;

            const utmContent = [
                getValueOrN("content_action"),
                getValueOrN("content_detail"),
                getValueOrN("content_version")
            ].join("_");
            document.getElementById("utm_content").value = utmContent;
			
            const utmTerm = document.getElementById("utm_term").value.trim();

            let finalURL = `${pageUrl}?utm_source=${utmSource}&utm_medium=${utmMedium}&utm_campaign=${utmCampaign}`;

            if (utmContent && utmContent !== "N_N_N") finalURL += `&utm_content=${utmContent}`;
            if (utmTerm) finalURL += `&utm_term=${utmTerm}`;

            document.getElementById("final_url").value = finalURL;
        }

        // í¼ ì œì¶œ ì‹œ ì²˜ë¦¬
        document.querySelector("form").addEventListener("submit", async (e) => {
            e.preventDefault();

            // 1. í¼ ë°ì´í„° ìˆ˜ì§‘
            const form = e.target;
            const formData = new FormData(form);

            // 2. ì¡°í•©ëœ final_urlë„ í•¨ê»˜ ì „ì†¡
            formData.append("final_url", document.getElementById("final_url").value);

            // 3. JSONìœ¼ë¡œ ë³€í™˜
            const jsonData = Object.fromEntries(formData.entries());

            try {
                // 4. n8n Webhook í˜¸ì¶œ
                const res = await fetch("http://localhost:5677/webhook-test/a7943c49-150a-4d3b-a383-4f86557ad15f", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(jsonData)
                });

                // 5. ì‘ë‹µ ì²˜ë¦¬
                const result = await res.json();

                if (result.short_url) {
                    document.getElementById("shortUrlInput").value = result.short_url;
                    document.getElementById("responseContainer").style.display = "block";
                } else {
                    alert("ë‹¨ì¶• URL ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

            } catch (err) {
                console.error("ì „ì†¡ ì˜¤ë¥˜:", err);
                alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        // ë³µì‚¬ ê¸°ëŠ¥
        function copyLink() {
            const input = document.getElementById("shortUrlInput");
            input.select();
            document.execCommand("copy");
            alert("âœ… ë³µì‚¬ ì™„ë£Œ!");
        }
    </script>
</body>
</html>
